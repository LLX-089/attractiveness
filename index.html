<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Beauty Judge</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #111; color: #fff; }
    img { width: 300px; height: auto; margin: 10px; border-radius: 8px; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    #photos div { display: inline-block; margin: 10px; }
    #uploadBtn[disabled] { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>Benvenuto a Beauty Judge</h1>

  <form id="roleForm">
    <label>
      <input type="radio" name="role" value="giudicato" required />
      Giudicato (carica la tua foto)
    </label>
    <br />
    <label>
      <input type="radio" name="role" value="giudice" />
      Giudice (valuta le foto)
    </label>
    <br />
    <button type="submit">Procedi</button>
  </form>

  <div id="uploadSection" style="display:none;">
    <h2>Carica la tua foto</h2>
    <input type="file" id="photoInput" accept="image/*" />
    <br/>
    <button id="uploadBtn">Carica Foto</button>
    <p id="uploadStatus" style="color: #0f0;"></p>
  </div>

  <div id="judgeSection" style="display:none;">
    <h2>Chi è più attraente?</h2>
    <div id="photos"></div>
  </div>

  <script>
    const roleForm = document.getElementById('roleForm');
    const uploadSection = document.getElementById('uploadSection');
    const judgeSection = document.getElementById('judgeSection');
    const uploadBtn = document.getElementById('uploadBtn');
    const photoInput = document.getElementById('photoInput');
    const uploadStatus = document.getElementById('uploadStatus');
    const photosContainer = document.getElementById('photos');

    // Memorizza la foto vincente dell'ultimo voto
    let lastWinner = null;

    roleForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const role = document.querySelector('input[name="role"]:checked').value;
      if (role === 'giudicato') {
        uploadSection.style.display = 'block';
        judgeSection.style.display = 'none';
      } else {
        uploadSection.style.display = 'none';
        judgeSection.style.display = 'block';
        lastWinner = null;  // resetto prima di iniziare a votare
        loadPhotos();
      }
      roleForm.style.display = 'none';
      uploadStatus.textContent = '';
      photoInput.value = '';
      uploadBtn.disabled = false;
    });

    uploadBtn.addEventListener('click', async () => {
      const file = photoInput.files[0];
      if (!file) {
        alert('Seleziona una foto prima di caricare.');
        return;
      }

      uploadBtn.disabled = true;
      uploadStatus.style.color = '#0f0';
      uploadStatus.textContent = 'Caricamento in corso...';

      const formData = new FormData();
      formData.append('photo', file);

      try {
        const response = await fetch('http://localhost:3000/upload', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) throw new Error('Server ha risposto con errore.');

        const data = await response.json();
        uploadStatus.textContent = `Foto caricata con successo: ${data.filename}`;
      } catch (error) {
        uploadStatus.style.color = '#f00';
        uploadStatus.textContent = 'Errore durante il caricamento.';
        console.error(error);
      } finally {
        uploadBtn.disabled = false;
      }
    });

    async function loadPhotos() {
      photosContainer.innerHTML = '';

      try {
        // Se ho una foto vincente dell'ultimo turno, carico solo lei + una casuale
        if (lastWinner) {
          // Chiedo tutte le foto per scegliere una random esclusa la lastWinner
          const resAll = await fetch('http://localhost:3000/all-photos');
          if (!resAll.ok) throw new Error('Errore caricamento foto');

          const allData = await resAll.json();
          let candidates = allData.photos.filter(p => p !== lastWinner);
          if (candidates.length === 0) {
            // Se c'è solo lastWinner, mostro solo quella
            showPhoto(lastWinner);
            return;
          }
          // prendo una random da candidati
          const randomPhoto = candidates[Math.floor(Math.random() * candidates.length)];
          showPhoto(lastWinner);
          showPhoto(randomPhoto);
        } else {
          // Carico due foto random classiche
          const res = await fetch('http://localhost:3000/random-photos');
          if (!res.ok) throw new Error('Errore caricamento foto');
          const data = await res.json();

          if (!data.photos || data.photos.length === 0) {
            photosContainer.textContent = 'Nessuna foto disponibile al momento.';
            return;
          }

          data.photos.forEach(photo => showPhoto(photo));
        }
      } catch (error) {
        photosContainer.textContent = 'Impossibile caricare le foto.';
        console.error(error);
      }
    }

    function showPhoto(photo) {
      const img = document.createElement('img');
      img.src = `http://localhost:3000/uploads/${photo}`;
      img.alt = 'Foto da giudicare';

      const btn = document.createElement('button');
      btn.textContent = 'Vota';
      btn.onclick = () => vote(photo);

      const div = document.createElement('div');
      div.appendChild(img);
      div.appendChild(btn);
      photosContainer.appendChild(div);
    }

    async function vote(winner) {
      alert(`Hai votato per ${winner}`);
      try {
        await fetch('http://localhost:3000/vote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ winner })
        });
        lastWinner = winner; // aggiorno la foto vincente
      } catch (error) {
        console.error('Errore invio voto:', error);
      }
      loadPhotos();
    }
  </script>
</body>
</html>
